# ============================================================================
# Promtail 3.3.0 Configuration
# Docker 컨테이너 로그 수집 설정
# ============================================================================

# ============================================================================
# 서버 설정
# ============================================================================
server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

# ============================================================================
# Position 파일 경로
# 로그 읽기 위치를 저장하여 재시작 시에도 이어서 읽을 수 있도록 함
# ============================================================================
positions:
  filename: /tmp/positions.yaml

# ============================================================================
# Loki 클라이언트 설정
# ============================================================================
clients:
  - url: http://loki:3100/loki/api/v1/push
    # 배치 설정으로 성능 최적화
    batchwait: 1s
    batchsize: 1048576

# ============================================================================
# 로그 수집 설정
# ============================================================================
scrape_configs:
  # Docker 컨테이너 로그 수집
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    # 라벨 재구성
    relabel_configs:
      # 컨테이너 이름을 라벨로 추가
      - source_labels: [ '__meta_docker_container_name' ]
        regex: '/(.*)'
        target_label: 'container'

      # 컨테이너 ID를 라벨로 추가
      - source_labels: [ '__meta_docker_container_id' ]
        target_label: 'container_id'

      # 이미지 이름을 라벨로 추가
      - source_labels: [ '__meta_docker_container_image' ]
        target_label: 'image'

      # 컨테이너 로그 경로 설정
      - source_labels: [ '__meta_docker_container_log_stream' ]
        target_label: 'stream'

      # logging 라벨이 "promtail"인 컨테이너만 수집
      - source_labels: [ '__meta_docker_container_label_logging' ]
        regex: 'promtail'
        action: keep

      # logging_jobname 라벨을 job으로 사용
      - source_labels: [ '__meta_docker_container_label_logging_jobname' ]
        target_label: 'job'

      # 네트워크 이름 추가
      - source_labels: [ '__meta_docker_network_name' ]
        target_label: 'network'

    # 파이프라인 설정 (JSON 로그 자동 파싱)
    pipeline_stages:
      # Docker 로그에서 JSON 파싱 시도
      - docker: { }

      # 로그 출력
      - output:
          source: output
